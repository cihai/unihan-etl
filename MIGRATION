# Migration notes

Migration and deprecation notes for unihan-etl are here, see {ref}`history` as well.

```{admonition} Welcome on board! ðŸ‘‹
1. ðŸ“Œ For safety, **always** pin the package
2. ðŸ“– Check the migration notes _(You are here)_
3. ðŸ“£ If you feel something got deprecated and it interrupted you - past, present, or future - voice your opinion on the [tracker].

   We want to make unihan-etl fun, reliable, and useful for users.

   API changes can be painful.

   If we can do something to draw the sting, we'll do it. We're taking a balanced approach. That's why these notes are here!

   (Please pin the package. ðŸ™)

   [tracker]: https://github.com/cihai/unihan-etl/discussions
```

## Next release

### pytest plugin: Fixture dataclass containers

The pytest plugin fixtures have been redesigned with better type safety and DX.
Fixtures that previously returned `zipfile.ZipFile` now return dataclass containers.

#### `unihan_quick_zip` and `unihan_mock_zip` return `UnihanZip`

Before:

```python
def test_example(unihan_mock_zip: zipfile.ZipFile) -> None:
    # This was broken - ZipFile was closed before return!
    files = unihan_mock_zip.namelist()  # Would fail
```

After:

```python
from unihan_etl.types import UnihanZip

def test_example(unihan_mock_zip: UnihanZip) -> None:
    # Access path directly
    assert unihan_mock_zip.exists()

    # Use context manager for open handle
    with unihan_mock_zip.open() as zf:
        files = zf.namelist()

    # Or use convenience property
    files = unihan_mock_zip.namelist
```

#### New primary fixtures: `unihan_quick` and `unihan_full`

New `UnihanDataset` container fixtures provide unified access to all dataset paths:

```python
from unihan_etl.types import UnihanDataset

def test_with_dataset(unihan_quick: UnihanDataset) -> None:
    assert unihan_quick.name == "quick"
    assert unihan_quick.zip.exists()
    print(unihan_quick.work_dir)
    print(unihan_quick.destination)
```

#### New lazy data fixture: `unihan_quick_data_lazy`

```python
from unihan_etl.types import UnihanData

def test_lazy_data(unihan_quick_data_lazy: UnihanData) -> None:
    # Data only loads when accessed
    expanded = unihan_quick_data_lazy.expanded
    by_char = unihan_quick_data_lazy.by_char
```

#### CLI option: `--unihan-cache-dir`

Override the cache directory via command line:

```bash
pytest --unihan-cache-dir=/tmp/my-cache
```

#### Marker: `@pytest.mark.unihan_full`

Mark tests requiring the full dataset:

```python
@pytest.mark.unihan_full
def test_full_dataset(unihan_full: UnihanDataset, unihan_ensure_full: None) -> None:
    assert unihan_full.is_ready
```

<!-- Maintainers, insert migration notes for the next release here -->

## unihan-etl 0.22.0 (2023-06-17)

### Move `unihan_etl.process` to `unihan_etl.core` (#284)

Before 0.22.0:

```python
from unihan_etl.process import Packager
```

From 0.22.0+:

```python
>>> from unihan_etl.core import Packager
```

### Options is now a dataclass object (#280)

A typed, autocomplete-friendly :obj:`dataclasses.dataclass` object is now used for the unihan_etl options object.

Before 0.22.0:

```python
from unihan_etl.process import Packager

packager = Packager({
    'fields': ['kDefinition']
})
```

From 0.22.0+ (also note above):

```python
>>> from unihan_etl.core import Packager
>>> from unihan_etl.options import Options
>>> packager = Packager(Options(
...     fields=['kDefinition']
... ))
```

<!--
# vim: set filetype=markdown:
-->
